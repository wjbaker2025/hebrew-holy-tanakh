<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tanakh Gematria Reader</title>
    <style>
        :root {
            color-scheme: dark;
            --bg: #0b0f1a;
            --panel: rgba(19, 26, 44, 0.92);
            --panel-strong: rgba(27, 36, 60, 0.98);
            --accent: #6ee7ff;
            --accent-strong: #8b5cf6;
            --highlight: #fbbf24;
            --highlight-text: #0f172a;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --shadow: 0 20px 45px rgba(0, 0, 0, 0.45);
            --border: rgba(148, 163, 184, 0.2);
            --radius-lg: 18px;
            --radius-md: 12px;
            --radius-sm: 8px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Plus Jakarta Sans", "Segoe UI", system-ui, sans-serif;
            background: radial-gradient(circle at top left, rgba(99, 102, 241, 0.2), transparent 40%),
                radial-gradient(circle at top right, rgba(14, 165, 233, 0.18), transparent 45%),
                var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .app-shell {
            display: grid;
            grid-template-columns: minmax(240px, 300px) minmax(0, 1fr);
            min-height: 100vh;
            gap: 24px;
            padding: 28px;
        }

        aside {
            background: var(--panel);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .brand {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(110, 231, 255, 0.18), transparent);
        }

        .brand h1 {
            margin: 0 0 6px;
            font-size: 1.35rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .brand p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .book-list {
            list-style: none;
            padding: 16px;
            margin: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .book-section {
            margin-top: 16px;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
        }

        .book-item {
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            color: var(--text);
        }

        .book-item:hover,
        .book-item.active {
            border-color: rgba(110, 231, 255, 0.45);
            background: linear-gradient(120deg, rgba(110, 231, 255, 0.15), rgba(139, 92, 246, 0.16));
            box-shadow: inset 0 0 0 1px rgba(110, 231, 255, 0.3);
        }

        .book-item:focus-visible {
            outline: 2px solid rgba(110, 231, 255, 0.7);
            outline-offset: 2px;
        }

        .book-item.is-disabled {
            opacity: 0.45;
            cursor: not-allowed;
            pointer-events: none;
        }

        main {
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 16px;
        }

        .top-bar {
            background: var(--panel);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 18px 22px;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
        }

        .search-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            flex: 1;
            min-width: 280px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 180px;
            flex: 1;
        }

        label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        input[type="text"],
        select {
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(15, 23, 42, 0.7);
            color: var(--text);
            font-size: 0.95rem;
        }

        button {
            padding: 10px 18px;
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: #020617;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(79, 70, 229, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .gematria-display {
            background: rgba(15, 23, 42, 0.7);
            border-radius: var(--radius-md);
            padding: 10px 14px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            min-width: 230px;
        }

        .gematria-display h3 {
            margin: 0 0 4px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .gematria-value {
            font-size: 1.4rem;
            color: var(--highlight);
            font-weight: 700;
        }

        .gematria-note {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .reader {
            background: var(--panel-strong);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #reader-container {
            overflow-y: auto;
            padding-right: 12px;
        }

        .chapter-title {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
            margin-bottom: 18px;
        }

        .chapter-title span {
            font-size: 0.9rem;
            color: var(--text-muted);
            letter-spacing: 0.16em;
            text-transform: uppercase;
        }

        .verse-container {
            margin-bottom: 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            line-height: 1.8;
        }

        .verse-number {
            font-weight: 700;
            color: var(--accent);
            font-size: 0.85rem;
            letter-spacing: 0.12em;
        }

        .word-card {
            background: rgba(15, 23, 42, 0.55);
            border-radius: var(--radius-sm);
            padding: 8px 10px;
            border: 1px solid rgba(148, 163, 184, 0.16);
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 70px;
            align-items: center;
            transition: transform 0.15s ease, border 0.15s ease;
        }

        .word-card:hover {
            transform: translateY(-2px);
            border-color: rgba(110, 231, 255, 0.35);
        }

        .word-hebrew {
            font-family: "Ezra SIL", "Times New Roman", serif;
            font-size: 1.35rem;
            direction: rtl;
        }

        .word-english {
            font-size: 0.78rem;
            color: var(--text-muted);
            text-align: center;
        }

        .word-meta {
            font-size: 0.68rem;
            color: rgba(148, 163, 184, 0.8);
            text-align: center;
        }

        .word-card.imprinted {
            background: var(--highlight);
        }

        .word-card.imprinted .word-hebrew,
        .word-card.imprinted .word-english,
        .word-card.imprinted .word-meta {
            color: var(--highlight-text);
            font-weight: 600;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 22px;
            background: var(--panel);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .nav-controls span {
            color: var(--text-muted);
            font-size: 0.9rem;
            letter-spacing: 0.12em;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.2);
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
        }

        .status-text {
            font-size: 0.75rem;
        }

        .loading-message {
            padding: 24px;
            color: var(--text-muted);
        }

        @media (max-width: 960px) {
            .app-shell {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="app-shell">
        <aside>
            <div class="brand">
                <h1>Tanakh Gematria</h1>
                <p>Interactive reader powered by the repository cipher definitions.</p>
                <div class="status-pill" role="status">
                    <span class="status-dot" aria-hidden="true"></span>
                    <span class="status-text">Status: Data synced from JSON</span>
                </div>
            </div>
            <ul class="book-list" id="book-list"></ul>
        </aside>

        <main>
            <div class="top-bar">
                <div class="search-group">
                    <div class="field">
                        <label for="gematria-search">Search & Imprint</label>
                        <input type="text" id="gematria-search" placeholder="Search word or Hebrew text" onkeypress="handleEnter(event)">
                    </div>
                    <div class="field">
                        <label for="cipher-select">Cipher</label>
                        <select id="cipher-select"></select>
                    </div>
                    <div class="field">
                        <label for="script-select">Script</label>
                        <select id="script-select">
                            <option value="auto">Auto Detect</option>
                            <option value="hebrew">Hebrew</option>
                            <option value="english">English</option>
                            <option value="greek">Greek</option>
                        </select>
                    </div>
                    <button onclick="imprintGematria()" aria-label="Calculate and highlight gematria matches">Imprint</button>
                </div>
                <div class="gematria-display" id="gematria-result">
                    <h3>Gematria Value</h3>
                    <div class="gematria-value">0</div>
                    <div class="status-pill" id="cipher-label">Biblical</div>
                    <div class="gematria-note" id="script-note">Script: Auto Detect</div>
                </div>
            </div>

            <section class="reader">
                <div id="reader-container">
                    <div id="bible-text"></div>
                </div>
            </section>

            <div class="nav-controls">
                <button onclick="prevChapter()" id="prev-button" aria-label="Go to previous chapter">← Previous Chapter</button>
                <span id="current-location">Genesis 1</span>
                <button onclick="nextChapter()" id="next-button" aria-label="Go to next chapter">Next Chapter →</button>
            </div>
        </main>
    </div>

    <script>
        const BOOK_INDEX = [
            { section: "Torah", name: "Genesis", path: "Tanakh/1. Torah - Instructions/01_genesis.json" },
            { section: "Torah", name: "Exodus", path: "Tanakh/1. Torah - Instructions/02_exodus.json" },
            { section: "Torah", name: "Leviticus", path: "Tanakh/1. Torah - Instructions/03_leviticus.json" },
            { section: "Torah", name: "Numbers", path: "Tanakh/1. Torah - Instructions/04_numbers.json" },
            { section: "Torah", name: "Deuteronomy", path: "Tanakh/1. Torah - Instructions/05_deuteronomy.json" },
            { section: "Former Prophets", name: "Joshua", path: "Tanakh/2. Nevi'im - Prophets/1. Former Prophets/06_joshua.json" },
            { section: "Former Prophets", name: "Judges", path: "Tanakh/2. Nevi'im - Prophets/1. Former Prophets/07_judges.json" },
            { section: "Former Prophets", name: "1 Samuel", path: "Tanakh/2. Nevi'im - Prophets/1. Former Prophets/08_1_samuel.json" },
            { section: "Former Prophets", name: "2 Samuel", path: "Tanakh/2. Nevi'im - Prophets/1. Former Prophets/09_2_samuel.json" },
            { section: "Former Prophets", name: "1 Kings", path: "Tanakh/2. Nevi'im - Prophets/1. Former Prophets/10_1_kings.json" },
            { section: "Former Prophets", name: "2 Kings", path: "Tanakh/2. Nevi'im - Prophets/1. Former Prophets/11_2_kings.json" },
            { section: "Latter Prophets", name: "Isaiah", path: "Tanakh/2. Nevi'im - Prophets/2. Latter Prophets/12_isaiah.json" },
            { section: "Latter Prophets", name: "Jeremiah", path: "Tanakh/2. Nevi'im - Prophets/2. Latter Prophets/13_jeremiah.json" },
            { section: "Latter Prophets", name: "Ezekiel", path: "Tanakh/2. Nevi'im - Prophets/2. Latter Prophets/14_ezekiel.json" },
            { section: "Minor Prophets", name: "Hosea", path: "Tanakh/2. Nevi'im - Prophets/3. Minor Prophets/15_hosea.json" },
            { section: "Minor Prophets", name: "Joel", path: "Tanakh/2. Nevi'im - Prophets/3. Minor Prophets/16_joel.json" },
            { section: "Minor Prophets", name: "Amos", path: "Tanakh/2. Nevi'im - Prophets/3. Minor Prophets/17_amos.json" },
            { section: "Minor Prophets", name: "Obadiah", path: "Tanakh/2. Nevi'im - Prophets/3. Minor Prophets/18_obadiah.json" },
            { section: "Minor Prophets", name: "Jonah", path: "Tanakh/2. Nevi'im - Prophets/3. Minor Prophets/19_jonah.json" },
            { section: "Minor Prophets", name: "Micah", path: "Tanakh/2. Nevi'im - Prophets/3. Minor Prophets/20_micah.json" },
            { section: "Minor Prophets", name: "Nahum", path: "Tanakh/2. Nevi'im - Prophets/3. Minor Prophets/21_nahum.json" },
            { section: "Minor Prophets", name: "Habakkuk", path: "Tanakh/2. Nevi'im - Prophets/3. Minor Prophets/22_habakkuk.json" },
            { section: "Minor Prophets", name: "Zephaniah", path: "Tanakh/2. Nevi'im - Prophets/3. Minor Prophets/23_zephaniah.json" },
            { section: "Minor Prophets", name: "Haggai", path: "Tanakh/2. Nevi'im - Prophets/3. Minor Prophets/24_haggai.json" },
            { section: "Minor Prophets", name: "Zechariah", path: "Tanakh/2. Nevi'im - Prophets/3. Minor Prophets/25_zechariah.json" },
            { section: "Minor Prophets", name: "Malachi", path: "Tanakh/2. Nevi'im - Prophets/3. Minor Prophets/26_malachi.json" },
            { section: "Writings", name: "Psalms", path: "Tanakh/3. Ketuvim - Writings/27_psalms.json" },
            { section: "Writings", name: "Proverbs", path: "Tanakh/3. Ketuvim - Writings/28_proverbs.json" },
            { section: "Writings", name: "Job", path: "Tanakh/3. Ketuvim - Writings/29_job.json" },
            { section: "Writings", name: "Song of Solomon", path: "Tanakh/3. Ketuvim - Writings/30_song_of_solomon.json" },
            { section: "Writings", name: "Ruth", path: "Tanakh/3. Ketuvim - Writings/31_ruth.json" },
            { section: "Writings", name: "Lamentations", path: "Tanakh/3. Ketuvim - Writings/32_lamentations.json" },
            { section: "Writings", name: "Ecclesiastes", path: "Tanakh/3. Ketuvim - Writings/33_ecclesiastes.json" },
            { section: "Writings", name: "Esther", path: "Tanakh/3. Ketuvim - Writings/34_esther.json" },
            { section: "Writings", name: "Daniel", path: "Tanakh/3. Ketuvim - Writings/35_daniel.json" },
            { section: "Writings", name: "Ezra", path: "Tanakh/3. Ketuvim - Writings/36_ezra.json" },
            { section: "Writings", name: "Nehemiah", path: "Tanakh/3. Ketuvim - Writings/37_nehemiah.json" },
            { section: "Writings", name: "1 Chronicles", path: "Tanakh/3. Ketuvim - Writings/38_1_chronicles.json" },
            { section: "Writings", name: "2 Chronicles", path: "Tanakh/3. Ketuvim - Writings/39_2_chronicles.json" }
        ];

        const FALLBACK_CIPHER_MAPS = {
            biblical: { "א": 1, "ב": 2, "ג": 3, "ש": 3, "ד": 4, "ת": 4, "ה": 5, "ו": 6, "ז": 7, "ח": 8, "ט": 9, "י": 10, "כ": 20, "ך": 20, "ל": 30, "מ": 40, "ם": 40, "נ": 50, "ן": 50, "ס": 60, "ע": 70, "פ": 80, "ף": 80, "צ": 90, "ץ": 90, "ק": 100, "ר": 200 },
            reversal: { "ת": 80, "ש": 90, "ר": 2, "ק": 1, "צ": 3, "ץ": 3, "פ": 4, "ף": 4, "ע": 5, "ס": 6, "נ": 7, "ן": 7, "מ": 8, "ם": 8, "ל": 9, "כ": 10, "ך": 10, "י": 20, "ט": 30, "ח": 40, "ז": 50, "ו": 60, "ה": 70, "ד": 80, "ג": 90, "ב": 200, "א": 100 },
            genesis_order: { "ב": 1, "א": 2, "ג": 3, "ש": 3, "ד": 4, "ת": 4, "ה": 5, "ו": 6, "ז": 7, "ח": 8, "ט": 9, "י": 10, "כ": 11, "ך": 11, "ל": 12, "מ": 13, "ם": 13, "נ": 14, "ן": 14, "ס": 15, "ע": 16, "פ": 17, "ף": 17, "צ": 18, "ץ": 18, "ק": 19, "ר": 20 },
            standard: { "א": 1, "ב": 2, "ג": 3, "ד": 4, "ה": 5, "ו": 6, "ז": 7, "ח": 8, "ט": 9, "י": 10, "כ": 20, "ך": 20, "ל": 30, "מ": 40, "ם": 40, "נ": 50, "ן": 50, "ס": 60, "ע": 70, "פ": 80, "ף": 80, "צ": 90, "ץ": 90, "ק": 100, "ר": 200, "ש": 300, "ת": 400 }
        };


        const FALLBACK_ENGLISH_ENTRIES = [
            { letter: "a", values: { biblical: 1, standard: 1, genesis: 2, reversal: 100 } },
            { letter: "b", values: { biblical: 2, standard: 2, genesis: 1, reversal: 200 } },
            { letter: "c", values: { biblical: 8, standard: 8, genesis: 8, reversal: 40 } },
            { letter: "d", values: { biblical: 4, standard: 4, genesis: 4, reversal: 80 } },
            { letter: "e", values: { biblical: 5, standard: 5, genesis: 5, reversal: 70 } },
            { letter: "f", values: { biblical: 80, standard: 80, genesis: 17, reversal: 4 } },
            { letter: "g", values: { biblical: 3, standard: 3, genesis: 3, reversal: 90 } },
            { letter: "h", values: { biblical: 5, standard: 5, genesis: 5, reversal: 70 } },
            { letter: "i", values: { biblical: 10, standard: 10, genesis: 10, reversal: 20 } },
            { letter: "j", values: { biblical: 10, standard: 10, genesis: 10, reversal: 20 } },
            { letter: "k", values: { biblical: 20, standard: 20, genesis: 11, reversal: 10 } },
            { letter: "l", values: { biblical: 30, standard: 30, genesis: 12, reversal: 9 } },
            { letter: "m", values: { biblical: 40, standard: 40, genesis: 13, reversal: 8 } },
            { letter: "n", values: { biblical: 50, standard: 50, genesis: 14, reversal: 7 } },
            { letter: "o", values: { biblical: 70, standard: 70, genesis: 16, reversal: 5 } },
            { letter: "p", values: { biblical: 80, standard: 80, genesis: 17, reversal: 4 } },
            { letter: "q", values: { biblical: 100, standard: 100, genesis: 19, reversal: 1 } },
            { letter: "r", values: { biblical: 200, standard: 200, genesis: 20, reversal: 2 } },
            { letter: "s", values: { biblical: 60, standard: 60, genesis: 15, reversal: 6 } },
            { letter: "t", values: { biblical: 9, standard: 9, genesis: 9, reversal: 30 } },
            { letter: "u", values: { biblical: 6, standard: 6, genesis: 6, reversal: 60 } },
            { letter: "v", values: { biblical: 6, standard: 6, genesis: 6, reversal: 60 } },
            { letter: "w", values: { biblical: 6, standard: 6, genesis: 6, reversal: 60 } },
            { letter: "x", values: { biblical: 60, standard: 60, genesis: 15, reversal: 6 } },
            { letter: "y", values: { biblical: 10, standard: 10, genesis: 10, reversal: 20 } },
            { letter: "z", values: { biblical: 7, standard: 7, genesis: 7, reversal: 50 } }
        ];

        const state = {
            currentBook: BOOK_INDEX[0],
            currentChapter: 1,
            activeSearchTerm: "",
            activeCipher: "biblical",
            scriptMode: "auto",
            bibleData: {},
            cipherData: {},
            englishMaps: {},
            previousScriptMode: "auto",
            loadError: null,
            highlightFrame: null
        };

        document.addEventListener("DOMContentLoaded", async () => {
            state.englishMaps = buildEnglishMaps(FALLBACK_ENGLISH_ENTRIES);
            await loadBookIndex();
            initBookList();
            initCipherSelector();
            await fetchCipherData();
            await loadBook(state.currentBook);
        });

        function initBookList() {
            const list = document.getElementById("book-list");
            list.innerHTML = "";
            let currentSection = "";
            BOOK_INDEX.forEach((book) => {
                if (book.section !== currentSection) {
                    currentSection = book.section;
                    const section = document.createElement("li");
                    section.textContent = currentSection;
                    section.className = "book-section";
                    list.appendChild(section);
                }
                const item = document.createElement("li");
                item.textContent = book.name;
                item.className = "book-item";
                item.setAttribute("role", "button");
                item.tabIndex = 0;
                const activateBook = () => {
                    if (item.classList.contains("is-disabled")) {
                        return;
                    }
                    loadBook(book);
                };
                item.addEventListener("click", activateBook);
                item.addEventListener("keydown", (event) => {
                    if (event.key === "Enter" || event.key === " ") {
                        event.preventDefault();
                        activateBook();
                    }
                });
                list.appendChild(item);
            });
            setActiveBook();
        }

        function initCipherSelector() {
            const cipherSelect = document.getElementById("cipher-select");
            cipherSelect.innerHTML = "";
            const cipherOptions = [
                { value: "biblical", label: "Biblical (Shin=3, Tav=4)" },
                { value: "reversal", label: "Reversal Cipher" },
                { value: "genesis_order", label: "Genesis Order" },
                { value: "standard", label: "Standard (Mispar Hechrechi)" },
                { value: "greek_transposition", label: "Greek Transposition" }
            ];
            cipherOptions.forEach((cipher) => {
                const option = document.createElement("option");
                option.value = cipher.value;
                option.textContent = cipher.label;
                cipherSelect.appendChild(option);
            });
            cipherSelect.value = state.activeCipher;
            cipherSelect.addEventListener("change", (event) => {
                state.activeCipher = event.target.value;
                if (state.activeCipher === "greek_transposition") {
                    state.previousScriptMode = state.scriptMode;
                    state.scriptMode = "greek";
                    scriptSelect.value = "greek";
                    scriptSelect.disabled = true;
                } else {
                    scriptSelect.disabled = false;
                    if (state.scriptMode === "greek" && state.previousScriptMode) {
                        state.scriptMode = state.previousScriptMode;
                        scriptSelect.value = state.scriptMode;
                    }
                }
                updateGematriaDisplay(calculateGematria(state.activeSearchTerm));
            });

            const scriptSelect = document.getElementById("script-select");
            scriptSelect.value = state.scriptMode;
            scriptSelect.addEventListener("change", (event) => {
                state.scriptMode = event.target.value;
                state.previousScriptMode = state.scriptMode;
                updateGematriaDisplay(calculateGematria(state.activeSearchTerm));
            });
        }

        async function loadBookIndex() {
            try {
                const response = await fetch("Tanakh/book_manifest.json", { cache: "no-cache" });
                if (!response.ok) {
                    return;
                }
                const manifest = await response.json();
                if (!Array.isArray(manifest) || manifest.length === 0) {
                    return;
                }
                const normalised = manifest
                    .filter((entry) => entry && entry.name && entry.path)
                    .map((entry) => ({
                        section: entry.section || "Unknown",
                        name: entry.name,
                        path: entry.path
                    }));
                if (normalised.length === 0) {
                    return;
                }
                BOOK_INDEX.length = 0;
                BOOK_INDEX.push(...normalised);
                state.currentBook = BOOK_INDEX[0];
            } catch (error) {
                console.warn("Unable to load book manifest", error);
            }
        }

        async function fetchCipherData() {
            try {
                const response = await fetch("gemantria/definitions/gemantria_ciphers.json");
                if (response.ok) {
                    const data = await response.json();
                    state.cipherData = data.ciphers || {};
                    state.englishMaps = buildEnglishMaps(data.languages?.english || []);
                    state.englishEntries = data.languages?.english || [];
                }
            } catch (error) {
                console.warn("Falling back to embedded cipher maps.", error);
            }
        }

        async function loadBook(book) {
            state.currentBook = book;
            state.currentChapter = 1;
            setActiveBook();
            const existing = state.bibleData[book.name];
            if (!existing) {
                const loaded = await fetchBookData(book, 1);
                if (!loaded) {
                    handleBookLoadError(book);
                    return;
                }
            let loadSucceeded = true;
            if (!existing) {
                // Attempt to fetch book data with a small number of retries.
                loadSucceeded = await fetchBookData(book, 1);
            }

            if (!loadSucceeded && !state.bibleData[book.name]) {
                // If we still have no data for this book, provide clear user feedback
                // and avoid rendering with undefined data.
                showBookLoadError(book);
                return;
            }

            renderPage();
        }

        // Simple helper to wait for the specified number of milliseconds.
        function wait(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
        }

        // Provide UI feedback when a book fails to load and prevent further interaction.
        function showBookLoadError(book) {
            console.error("Failed to load book data after retries:", book);
            alert("Unable to load data for \"" + book.name + "\". Please check your connection or try again later.");

            const items = document.querySelectorAll(".book-item");
            items.forEach((item) => {
                if (item.textContent === book.name) {
                    item.classList.add("disabled");
                    item.setAttribute("aria-disabled", "true");
                }
            });
        }

        async function fetchBookData(book, retries = 0) {
            try {
                const response = await fetch(book.path);
                if (!response.ok) {
                    throw new Error("Book fetch failed with status " + response.status);
                }
                const data = await response.json();
                state.bibleData[book.name] = data[book.name];
                return true;
            } catch (error) {
                console.warn("Unable to load book data for", book.name, error);
                if (retries > 0) {
                    // Basic retry logic with a short delay before the next attempt.
                    await wait(500);
                    return fetchBookData(book, retries - 1);
                }
                return false;
                if (retries > 0) {
                    await wait(500);
                    return fetchBookData(book, retries - 1);
                }
                return false;
            }
        }

        function wait(ms) {
            return new Promise((resolve) => setTimeout(resolve, ms));
        }

        function setActiveBook() {
            const items = document.querySelectorAll(".book-item");
            items.forEach((item) => {
                item.classList.toggle("active", item.textContent === state.currentBook.name);
            });
        }

        function getCipherMap() {
            if (state.activeCipher === "greek_transposition") {
                return (
                    state.cipherData.greek_transposition?.mapping ||
                    state.cipherData.greek_transposition?.values ||
                    FALLBACK_GREEK_MAP
                );
            }
            return (
                state.cipherData[state.activeCipher]?.mapping ||
                state.cipherData[state.activeCipher]?.values ||
                FALLBACK_CIPHER_MAPS[state.activeCipher]
            );
        }

        function detectScript(text) {
            if (!text) {
                return "hebrew";
            }
            if (state.scriptMode !== "auto") {
                return state.scriptMode;
            }
            if (/[\u0590-\u05FF]/.test(text)) {
                return "hebrew";
            }
            if (/[\u0370-\u03FF]/.test(text)) {
                return "greek";
            }
            return "english";
        }

        function calculateGematria(text) {
            if (!text) {
                return 0;
            }
            const script = detectScript(text);
            if (script === "english") {
                const map = state.englishMaps[state.activeCipher] || {};
                return [...text.toUpperCase()].reduce((sum, char) => sum + (map[char] || 0), 0);
            }
            const map = getCipherMap();
            return [...text].reduce((sum, char) => sum + (map[char] || 0), 0);
        }

        function renderPage() {
            const container = document.getElementById("bible-text");
            const chapters = state.bibleData[state.currentBook.name]?.chapters;

            if (!chapters || !chapters[state.currentChapter]) {
                container.innerHTML = `<div class="loading-message">${state.loadError || `Chapter ${state.currentChapter} is not available for ${state.currentBook.name}.`}</div>`;
                updateNavigationState(chapters);
                return;
            }

            const versesObj = chapters[state.currentChapter];
            let html = `<div class="chapter-title">${state.currentBook.name} <span>${state.currentBook.section}</span></div>`;
            const verseKeys = Object.keys(versesObj).sort((a, b) => parseInt(a, 10) - parseInt(b, 10));

            verseKeys.forEach((vNum) => {
                const words = versesObj[vNum];
                html += `<div class="verse-container"><span class="verse-number">${vNum}</span>`;

                words.forEach((word) => {
                    const isMatch = checkMatch(word);
                    const highlightClass = isMatch ? "imprinted" : "";
                    html += `
                        <div class="word-card ${highlightClass}" data-hebrew="${word.hebrew || ""}" data-english="${word.english || ""}">
                            <div class="word-hebrew">${word.hebrew || ""}</div>
                            <div class="word-english">${word.english || "-"}</div>
                            <div class="word-meta">${word.morphology || ""}</div>
                        </div>
                    `;
                });

                html += `</div>`;
            });

            container.innerHTML = html;
            document.getElementById("current-location").innerText = `${state.currentBook.name} ${state.currentChapter}`;
            updateNavigationState(chapters);
        }

        function normalizeHebrew(text) {
            return text.replace(/[^\u0590-\u05FF\s]/g, "");
        }

        function checkMatch(wordObj) {
            if (!state.activeSearchTerm) {
                return false;
            }
            const term = state.activeSearchTerm.trim().toLowerCase();
            const eng = (wordObj.english || "").toLowerCase();
            const heb = normalizeHebrew(wordObj.hebrew || "");
            const termHeb = normalizeHebrew(term);
            return eng.includes(term) || heb.includes(termHeb);
        }

        function updateGematriaDisplay(value) {
            const display = document.getElementById("gematria-result");
            const label = document.getElementById("cipher-label");
            const scriptNote = document.getElementById("script-note");
            display.querySelector(".gematria-value").textContent = value > 0 ? value : "N/A";
            label.textContent = state.activeCipher.replace(/_/g, " ");
            scriptNote.textContent = `Script: ${state.scriptMode === "auto" ? "Auto Detect" : state.scriptMode}`;
        }

        function imprintGematria() {
            const input = document.getElementById("gematria-search");
            state.activeSearchTerm = input.value;
            updateGematriaDisplay(calculateGematria(state.activeSearchTerm));
            queueHighlightUpdate();
        }

        function handleEnter(event) {
            if (event.key === "Enter") {
                imprintGematria();
            }
        }

        function nextChapter() {
            const chapters = state.bibleData[state.currentBook.name]?.chapters;
            if (!chapters) {
                return;
            }
            const keys = Object.keys(chapters).map((key) => parseInt(key, 10));
            const maxChapter = Math.max(...keys);
            if (state.currentChapter < maxChapter) {
                state.currentChapter += 1;
                renderPage();
                document.getElementById("reader-container").scrollTop = 0;
            }
        }

        function prevChapter() {
            if (state.currentChapter > 1) {
                state.currentChapter -= 1;
                renderPage();
                document.getElementById("reader-container").scrollTop = 0;
            }
        }

        function updateHighlighting() {
            const cards = document.querySelectorAll(".word-card");
            cards.forEach((card) => {
                const heb = card.dataset.hebrew || "";
                const eng = card.dataset.english || "";
                const matches = checkMatch({ hebrew: heb, english: eng });
                if (matches) {
                    card.classList.add("imprinted");
                } else {
                    card.classList.remove("imprinted");
                }
            });
        }

        function queueHighlightUpdate() {
            if (state.highlightFrame) {
                cancelAnimationFrame(state.highlightFrame);
            }
            state.highlightFrame = requestAnimationFrame(() => {
                updateHighlighting();
                state.highlightFrame = null;
            });
        }

        function updateNavigationState(chapters) {
            const prevButton = document.getElementById("prev-button");
            const nextButton = document.getElementById("next-button");
            if (!chapters) {
                prevButton.disabled = true;
                nextButton.disabled = true;
                return;
            }
            const keys = Object.keys(chapters).map((key) => parseInt(key, 10));
            const maxChapter = Math.max(...keys);
            prevButton.disabled = state.currentChapter <= 1;
            nextButton.disabled = state.currentChapter >= maxChapter;
        }

        function handleBookLoadError(book) {
            state.loadError = `Unable to load ${book.name}. Please check your connection or try again.`;
            const items = document.querySelectorAll(".book-item");
            items.forEach((item) => {
                if (item.textContent === book.name) {
                    item.classList.add("is-disabled");
                    item.setAttribute("aria-disabled", "true");
                }
            });
            renderPage();
        }

        function buildEnglishMaps(entries) {
            const maps = {
                biblical: {},
                reversal: {},
                genesis_order: {},
                standard: {}
            };
            entries.forEach((entry) => {
                const letter = (entry.letter || "").toUpperCase();
                if (!letter) {
                    return;
                }
                maps.biblical[letter] = entry.values?.biblical ?? 0;
                maps.reversal[letter] = entry.values?.reversal ?? 0;
                maps.genesis_order[letter] = entry.values?.genesis ?? 0;
                maps.standard[letter] = entry.values?.standard ?? 0;
            });
            return maps;
        }
    </script>
</body>
</html>
